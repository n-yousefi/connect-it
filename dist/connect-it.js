!function(){const e=(e,s)=>{let r;for(const[i,n]of Object.entries(s))if(!r){const s=t(e,n);s&&(r=s)}return r},t=(e,t)=>{var s=((t.x2-t.x1)*(e.y1-t.y1)-(t.y2-t.y1)*(e.x1-t.x1))/((t.y2-t.y1)*(e.x2-e.x1)-(t.x2-t.x1)*(e.y2-e.y1)),r=((e.x2-e.x1)*(e.y1-t.y1)-(e.y2-e.y1)*(e.x1-t.x1))/((t.y2-t.y1)*(e.x2-e.x1)-(t.x2-t.x1)*(e.y2-e.y1));return s>=0&&s<=1&&r>=0&&r<=1?{x:e.x1+s*(e.x2-e.x1),y:e.y1+s*(e.y2-e.y1)}:null},s=(e,t)=>({x1:e.x,y1:e.y,x2:t.x,y2:t.y});var r=(t,r)=>{const i=s(t.center,r.center),n=e(i,t.tagLines),o=e(i,r.tagLines);return s(n,o)},i=e=>{const t={x:(s=e).offsetLeft+s.offsetWidth/2,y:s.offsetTop+s.offsetHeight/2};var s;const r=(e=>{var t=new Object;return t.left={x1:e.offsetLeft,y1:e.offsetTop,x2:e.offsetLeft,y2:e.offsetTop+e.offsetHeight},t.top={x1:e.offsetLeft,y1:e.offsetTop,x2:e.offsetLeft+e.offsetWidth,y2:e.offsetTop},t.bottom={x1:e.offsetLeft,y1:e.offsetTop+e.offsetHeight,x2:e.offsetLeft+e.offsetWidth,y2:e.offsetTop+e.offsetHeight},t.right={x1:e.offsetLeft+e.offsetWidth,y1:e.offsetTop,x2:e.offsetLeft+e.offsetWidth,y2:e.offsetTop+e.offsetHeight},t})(e);return{center:t,tagLines:r}};class n{constructor(e){this.nodes=this.parseNodes(e),this.shapes=this.parseAll(e,'shapes shape');const t=this.parseAll(e,'edges edge');this.setShapeIds(),this.setNodesAdjecentsAndProps(t),this.links=this.getLinks()}setNodesAdjecentsAndProps(e){e.forEach((e=>{const t=this.getById(this.nodes,e.from),s=this.getById(this.nodes,e.to);s&&t&&(s.center.x!==t.center.x||s.center.y!==t.center.y)&&t.adjacents.push({to:s,...this.getMarkers(e),color:e.color,size:e.size})}))}getLinks(){const e=[];return this.nodes.forEach(((t,s)=>{t.adjacents.forEach((s=>{const i=r(t,s.to);e.push({line:i,markerStart:s.markerStart?.id+'Start',markerEnd:s.markerEnd?.id+'End',color:s.color,size:s.size})}))})),e}parseAll(e,t){return[...e.querySelectorAll(t)].map(this.parseTag)}getById(e,t){return e.filter((e=>e.id==t))[0]}getByName(e,t){return e.filter((e=>e.name==t))[0]}getMarkers(e){return{markerStart:this.getByName(this.shapes,e['marker-start']),markerEnd:this.getByName(this.shapes,e['marker-end'])}}setShapeIds(){this.shapes.forEach((e=>e.id=e.name))}parseNodes(e){const t=[];return e.querySelectorAll('nodes *[id]').forEach(((e,s)=>{const r=i(e);t.push({id:e.attributes.id?.value,...r,adjacents:[]})})),t}parseTag=e=>{const t={name:e.tagName,...this.getAttributes(e)};return e.children.length>0&&(t.children=[...e.children].map(this.parseTag)),t};getAttributes(e){const t=[];return[...e.attributes].map((e=>{t[e.name]=e.value})),t}}class o{constructor(e){this.shape=e}createMarker(){const e=document.createElementNS('http://www.w3.org/2000/svg','marker');return e.setAttribute('id',this.shape.id+this.type),e.setAttribute('orient','auto'),e.setAttribute('refY',this.refY),e.setAttribute('refX',this.refX),e.setAttribute('markerHeight',this.size),e.setAttribute('markerWidth',this.size),e.setAttribute('viewBox',`0 0 ${this.size} ${this.size}`),e}}class h extends o{constructor(e){super(e),this.type='Start',this.size=e.size??6,this.center=this.size/2,this.color=e.color??'black',this.refX=0,this.refY=this.center}createMarker(){const e=super.createMarker(),t=document.createElementNS('http://www.w3.org/2000/svg','polygon');return t.setAttribute('points',`0,0 0,${this.size} ${this.center},${this.center}`),t.setAttribute('fill',this.color),e.appendChild(t),e}}class a extends o{constructor(e){super(e),this.type='Start',this.size=e.size??6,this.center=this.size/2,this.color=e.color??'black',this.refX=0,this.refY=this.center}createMarker(){const e=super.createMarker(),t=document.createElementNS('http://www.w3.org/2000/svg','circle');return t.setAttribute('cx',this.center),t.setAttribute('cy',this.center),t.setAttribute('r',this.center),t.setAttribute('fill',this.color),e.appendChild(t),e}}class c extends o{constructor(e){super(e),this.type='Start',this.size=e.size??6,this.center=this.size/2,this.color=e.color??'black',this.refX=0,this.refY=this.center/2}createMarker(){const e=super.createMarker(),t=document.createElementNS('http://www.w3.org/2000/svg','rect');return t.setAttribute('x','0'),t.setAttribute('y','0'),t.setAttribute('width',this.center),t.setAttribute('height',this.center),t.setAttribute('fill',this.color),e.appendChild(t),e}}class l{constructor(e){this.connectIt=e}refreshEdges(){this.graphics=this.resetGraphics(),this.connectIt.vdom.links.forEach(((e,t)=>{this.graphics.main.appendChild(this.createPath(e,!1)),this.graphics.shadows.appendChild(this.createPath(e,!0))}))}resetGraphics(){const e=this.connectIt.querySelector('svg > g.gmain'),t=this.connectIt.querySelector('svg > g.gshadow');return e.innerHTML='',t.innerHTML='',{main:e,shadows:t}}createPath(e,t){const s=document.createElementNS('http://www.w3.org/2000/svg','path');s.setAttribute('d',`M${Math.round(e.line.x1)},${Math.round(e.line.y1)} L${Math.round(e.line.x2)},${Math.round(e.line.y2)} `);const r=e.size??2;return t?(s.setAttribute('stroke','black'),s.setAttribute('opacity',0),s.setAttribute('stroke-width',Math.max(r,15)),s.style='pointer-events: auto;'):t||(s.setAttribute('stroke-width',r),e.color&&s.setAttribute('stroke',e.color??'black'),s.setAttribute('marker-start',`url(#${e.markerStart})`),s.setAttribute('marker-end',`url(#${e.markerEnd})`)),s}}class d{constructor(e){this.element=e,this.init(),this.edge=new l(e)}init(){this.svg=this.createSVG(),this.element.appendChild(this.svg),this.element.defs=this.svg.querySelector('defs')}refresh(){const e=new n(this.element);var t;JSON.stringify(e)!==JSON.stringify(this.element.vdom)&&(this.element.vdom=e,(t=this.element).defs.innerHTML='',t.vdom.shapes.forEach((e=>{let s=null,r=null;switch(e.type){case'triangle':s=new h(e),r=new h(e),r.type='End',r.refX=r.center;break;case'circle':s=new a(e),r=new a(e),r.type='End',r.refX=r.size;break;case'square':s=new c(e),r=new c(e),r.type='End',r.refX=r.center}t.defs.appendChild(s.createMarker()),t.defs.appendChild(r.createMarker())})),this.edge.refreshEdges(),this.resizeSVG())}resizeSVG(){var e=this.svg.getBBox();this.svg.setAttribute('width',e.x+e.width+e.x),this.svg.setAttribute('height',e.y+e.height+e.y)}createSVG(){const e=document.createElementNS('http://www.w3.org/2000/svg','svg');return this.setSVGProperties(e),e.appendChild(this.createDefs()),e.appendChild(this.createGmain()),e.appendChild(this.createGshadow()),e}createDefs(){return document.createElementNS('http://www.w3.org/2000/svg','defs')}createGmain(){const e=document.createElementNS('http://www.w3.org/2000/svg','g');return e.setAttribute('class','gmain'),e.setAttribute('fill','none'),e.setAttribute('stroke','black'),e.setAttribute('stroke-width','2'),e}createGshadow(){const e=document.createElementNS('http://www.w3.org/2000/svg','g');return e.setAttribute('class','gshadow'),e}setSVGProperties(e){e.setAttribute('style','position: absolute; top: 0; left: 0; pointer-events: none;')}resetSVG(e){e.innerHTML=''}}class f{constructor(e){this.element=e}refresh=()=>{this.element.refresh()};refreshOnImagesLoaded(){Promise.all(Array.from(this.element.querySelectorAll('img')).filter((e=>!e.complete)).map((e=>new Promise((t=>{e.onload=e.onerror=t}))))).then(this.refresh)}refreshOnScroll(){document.addEventListener('scroll',this.refresh),window.addEventListener('resize',this.refresh)}disposeRefreshOnScroll(){this.observer.disconnect()}refreshOnUserChanges(){this.observer=new MutationObserver((e=>{e.forEach((e=>{(e.target.parent!=this.element||e.target.closest('nodes'))&&this.refresh()}))})),this.observer.observe(document,{attributes:!0,childList:!0,subtree:!0})}disposeRefreshOnUserChanges(){document.removeEventListener('scroll',this.refresh),window.removeEventListener('resize',this.refresh)}addMouseEvents(){this.element.addEventListener('click',(e=>{e.target.parentElement.classList.contains('gshadow')&&this.fireHandler('click',e)})),this.element.addEventListener('mouseout',(e=>{e.target.parentElement.classList.contains('gshadow')&&this.fireHandler('mouseout',e)})),this.element.addEventListener('mouseover',(e=>{e.target.parentElement.classList.contains('gshadow')&&this.fireHandler('mouseover',e)}))}fireHandler(e,t){const s='onEdges'+e.charAt(0).toUpperCase()+e.slice(1),r=this.element[s];r&&r(this.getRelatedPath(t.target)),this.refresh(),t.stopPropagation()}getRelatedPath(e){const t=Array.prototype.indexOf.call(e.parentElement.childNodes,e);return this.element.querySelector(`edges edge:nth-child(${t+1})`)}}class u extends HTMLElement{constructor(){super(),this.svg=new d(this),this.events=new f(this)}connectedCallback(){this.events.refreshOnImagesLoaded(),this.events.refreshOnScroll(),this.events.refreshOnUserChanges(),this.events.addMouseEvents()}disconnectedCallback(){this.events.disposeRefreshOnScroll(),this.events.disposeRefreshOnUserChanges()}refresh(){this.svg.refresh()}}customElements.get('connect-it')||customElements.define('connect-it',u)}();
//# sourceMappingURL=connect-it.js.map
